---
/**
 * Search Bar Component with client-side filtering
 * Filters products by name and description in real-time
 */
interface Props {
  placeholder?: string;
  id?: string;
}

const { 
  placeholder = 'Buscar productos...', 
  id = 'search' 
} = Astro.props;
---

<div class="search-container relative">
  <input
    type="search"
    id={id}
    name={id}
    placeholder={placeholder}
    autocomplete="off"
    class="w-full px-4 py-3 pl-12 rounded-lg border border-gray-light bg-white text-dark-slate placeholder:text-muted-slate focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent transition-all"
  />
  <svg 
    class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-slate pointer-events-none"
    fill="none" 
    stroke="currentColor" 
    viewBox="0 0 24 24"
  >
    <path 
      stroke-linecap="round" 
      stroke-linejoin="round" 
      stroke-width="2" 
      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
    />
  </svg>
  
  <!-- Clear button -->
  <button
    type="button"
    id={`${id}-clear`}
    class="absolute right-3 top-1/2 -translate-y-1/2 p-1 text-muted-slate hover:text-dark-slate transition-colors hidden"
    aria-label="Limpiar búsqueda"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
  </button>
</div>

<!-- Results count -->
<p id={`${id}-results`} class="text-muted-slate text-center mt-4 mb-6 transition-opacity">
  <!-- Updated dynamically -->
</p>

<!-- No results message -->
<div id={`${id}-no-results`} class="hidden text-center py-8">
  <svg class="w-16 h-16 mx-auto text-gray-light mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
  </svg>
  <p class="text-muted-slate text-lg mb-2">No se encontraron productos</p>
  <p class="text-gray-mid text-sm">Intenta con otros términos de búsqueda</p>
</div>

<script define:vars={{ searchId: id }}>
  /**
   * Client-side product search functionality
   * Filters products by name and description
   */
  
  const searchInput = document.getElementById(searchId);
  const clearBtn = document.getElementById(`${searchId}-clear`);
  const resultsText = document.getElementById(`${searchId}-results`);
  const noResultsMsg = document.getElementById(`${searchId}-no-results`);
  const productsGrid = document.getElementById('products-grid');
  
  if (searchInput && productsGrid) {
    const productCards = Array.from(productsGrid.querySelectorAll('article.product-card'));
    const totalProducts = productCards.length;
    
    // Initialize results count
    updateResultsCount(totalProducts);
    
    // Debounce function to avoid excessive filtering
    function debounce(fn, delay) {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), delay);
      };
    }
    
    // Normalize text for search (remove accents, lowercase)
    function normalizeText(text) {
      return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }
    
    // Filter products based on search query
    function filterProducts(query) {
      const normalizedQuery = normalizeText(query.trim());
      let visibleCount = 0;
      
      productCards.forEach(card => {
        const link = card.querySelector('a');
        const name = card.querySelector('h3')?.textContent || '';
        const normalizedName = normalizeText(name);
        
        // Check if product name matches query
        const matches = normalizedQuery === '' || normalizedName.includes(normalizedQuery);
        
        if (matches) {
          card.style.display = '';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      updateResultsCount(visibleCount);
      toggleNoResults(visibleCount === 0 && normalizedQuery !== '');
      toggleClearButton(query.length > 0);
    }
    
    function updateResultsCount(count) {
      if (resultsText) {
        const text = count === 1 
          ? '1 producto encontrado' 
          : `${count} productos encontrados`;
        resultsText.textContent = text;
      }
    }
    
    function toggleNoResults(show) {
      if (noResultsMsg) {
        noResultsMsg.classList.toggle('hidden', !show);
      }
      if (productsGrid) {
        productsGrid.classList.toggle('hidden', show);
      }
    }
    
    function toggleClearButton(show) {
      if (clearBtn) {
        clearBtn.classList.toggle('hidden', !show);
      }
    }
    
    // Event listeners
    const debouncedFilter = debounce(filterProducts, 200);
    
    searchInput.addEventListener('input', (e) => {
      debouncedFilter(e.target.value);
    });
    
    // Clear button
    clearBtn?.addEventListener('click', () => {
      searchInput.value = '';
      filterProducts('');
      searchInput.focus();
    });
    
    // Handle form submission (prevent page reload)
    searchInput.closest('form')?.addEventListener('submit', (e) => {
      e.preventDefault();
    });
  }
</script>

<style>
  .search-container {
    /* Ensure proper stacking */
    z-index: 10;
  }
</style>
